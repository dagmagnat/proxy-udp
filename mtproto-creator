#!/usr/bin/env bash
set -euo pipefail

# =========================
# MTProto Proxy Manager (RU)
# =========================

CONF="/etc/mtproto_manager.conf"
CONTAINER_NAME="mtproto-proxy"
IMAGE="telegrammessenger/proxy:latest"

require_root() {
  if [[ "${EUID}" -ne 0 ]]; then
    echo "Запустите от root: sudo $0" >&2
    exit 1
  fi
}

cmd_exists() { command -v "$1" >/dev/null 2>&1; }

valid_port() {
  local p="${1:-}"
  [[ "$p" =~ ^[0-9]+$ ]] || return 1
  (( p >= 1 && p <= 65535 )) || return 1
  return 0
}

port_allowed() {
  local p="$1"
  # Запрещаем 80 и 443 (как вы попросили)
  [[ "$p" != "80" && "$p" != "443" ]] || return 1
  return 0
}

port_free() {
  local p="$1"
  # Проверяем, что порт не занят (TCP LISTEN)
  if cmd_exists ss; then
    ! ss -lnt "( sport = :$p )" 2>/dev/null | grep -q ":$p"
  elif cmd_exists netstat; then
    ! netstat -lnt 2>/dev/null | awk '{print $4}' | grep -q ":$p$"
  else
    # если нечем проверять — пропускаем (best effort)
    return 0
  fi
}

rand_hex_16bytes() {
  # 16 bytes => 32 hex-символа
  if cmd_exists openssl; then
    openssl rand -hex 16
  else
    head -c 16 /dev/urandom | od -An -tx1 | tr -d ' \n'
  fi
}

choose_port() {
  echo
  echo "Выбор порта для MTProto Proxy (TCP)."
  echo "Порты 80 и 443 запрещены."
  echo "1) Случайный свободный порт (рекомендуется)"
  echo "2) Указать свой порт"
  echo "0) Назад"
  echo
  read -r -p "Ваш выбор: " sel

  case "$sel" in
    1)
      local p tries=0
      while true; do
        # диапазон 20000-65000, чтобы реже конфликтовать
        p=$((20000 + (RANDOM % 45000)))
        tries=$((tries + 1))
        if valid_port "$p" && port_allowed "$p" && port_free "$p"; then
          echo "$p"
          return 0
        fi
        (( tries >= 200 )) && { echo "Не смог подобрать свободный порт." >&2; return 1; }
      done
      ;;
    2)
      local p
      read -r -p "Введите порт (1-65535, кроме 80/443): " p
      valid_port "$p" || { echo "Неверный порт." >&2; return 1; }
      port_allowed "$p" || { echo "Порт 80/443 запрещён." >&2; return 1; }
      port_free "$p" || { echo "Порт занят." >&2; return 1; }
      echo "$p"
      return 0
      ;;
    0)
      echo "back"
      return 0
      ;;
    *)
      echo "Неверный выбор." >&2
      return 1
      ;;
  esac
}

install_docker_apt() {
  apt-get update -y
  apt-get install -y docker.io
  systemctl enable --now docker
}

ensure_docker() {
  if cmd_exists docker; then
    return 0
  fi

  echo "Docker не найден. Пытаюсь установить..."

  if cmd_exists apt-get; then
    install_docker_apt
  else
    echo "Автоустановка поддерживается только для Debian/Ubuntu (apt). Установите Docker вручную." >&2
    exit 1
  fi

  cmd_exists docker || { echo "Docker не установился." >&2; exit 1; }
}

save_conf() {
  local port="$1" secret="$2" tag="$3"
  cat > "$CONF" <<EOF
PORT=$port
SECRET=$secret
TAG=$tag
CONTAINER=$CONTAINER_NAME
IMAGE=$IMAGE
EOF
  chmod 600 "$CONF"
}

load_conf() {
  if [[ -f "$CONF" ]]; then
    # shellcheck disable=SC1090
    source "$CONF"
  else
    PORT=""
    SECRET=""
    TAG=""
  fi
}

open_firewall_iptables() {
  local port="$1"
  # Открываем TCP порт в iptables (best effort)
  if cmd_exists iptables; then
    iptables -C INPUT -p tcp --dport "$port" -j ACCEPT 2>/dev/null || \
      iptables -I INPUT -p tcp --dport "$port" -j ACCEPT
  fi
}

get_public_ip() {
  local ip=""
  if cmd_exists curl; then
    ip="$(curl -fsS --max-time 3 https://api.ipify.org 2>/dev/null || true)"
    [[ -z "$ip" ]] && ip="$(curl -fsS --max-time 3 https://ifconfig.me 2>/dev/null || true)"
  elif cmd_exists wget; then
    ip="$(wget -qO- --timeout=3 https://api.ipify.org 2>/dev/null || true)"
    [[ -z "$ip" ]] && ip="$(wget -qO- --timeout=3 https://ifconfig.me 2>/dev/null || true)"
  fi
  echo "$ip"
}

показать_ссылку() {
  load_conf
  if [[ -z "${PORT:-}" || -z "${SECRET:-}" ]]; then
    echo "Прокси не настроен (нет конфигурации)." >&2
    return 1
  fi

  local ip
  ip="$(get_public_ip)"

  echo
  echo "Данные MTProto Proxy:"
  echo "Порт  : $PORT"
  echo "Секрет: dd$SECRET"
  [[ -n "${TAG:-}" ]] && echo "TAG   : $TAG"
  echo

  if [[ -n "$ip" ]]; then
    echo "IP сервера: $ip"
    echo
    echo "Ссылка для Telegram:"
    echo "tg://proxy?server=${ip}&port=${PORT}&secret=dd${SECRET}"
  else
    echo "Не удалось определить публичный IP автоматически."
    echo "Вставьте свой IP вручную:"
    echo "tg://proxy?server=ВАШ_IP&port=${PORT}&secret=dd${SECRET}"
  fi

  echo
}

запустить_прокси() {
  ensure_docker
  load_conf

  local port secret tag

  if [[ -z "${PORT:-}" || -z "${SECRET:-}" ]]; then
    port="$(choose_port)" || return 1
    [[ "$port" == "back" ]] && return 0

    secret="$(rand_hex_16bytes)"
    tag=""
    save_conf "$port" "$secret" "$tag"
    load_conf
  fi

  # если контейнер уже есть — удалим, чтобы пересоздать корректно
  if docker ps -a --format '{{.Names}}' | grep -qx "$CONTAINER_NAME"; then
    docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1 || true
  fi

  echo "Запускаю MTProto Proxy в Docker..."
  docker pull "$IMAGE" >/dev/null

  # контейнер слушает 443 внутри, наружу мапим выбранный порт PORT
  if [[ -n "${TAG:-}" ]]; then
    docker run -d \
      --name "$CONTAINER_NAME" \
      --restart unless-stopped \
      -p "${PORT}:443" \
      -e "SECRET=${SECRET}" \
      -e "TAG=${TAG}" \
      "$IMAGE" >/dev/null
  else
    docker run -d \
      --name "$CONTAINER_NAME" \
      --restart unless-stopped \
      -p "${PORT}:443" \
      -e "SECRET=${SECRET}" \
      "$IMAGE" >/dev/null
  fi

  open_firewall_iptables "$PORT"

  echo "MTProto Proxy запущен."
  показать_ссылку
}

остановить_прокси() {
  ensure_docker
  if docker ps --format '{{.Names}}' | grep -qx "$CONTAINER_NAME"; then
    docker stop "$CONTAINER_NAME" >/dev/null
    echo "Остановлено."
  else
    echo "Контейнер не запущен."
  fi
}

статус() {
  ensure_docker
  load_conf
  echo
  echo "Статус контейнера:"
  docker ps -a --filter "name=^/${CONTAINER_NAME}$" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
  echo
  if [[ -f "$CONF" ]]; then
    echo "Конфиг: $CONF"
    echo "PORT=${PORT:-}"
    echo "SECRET=dd${SECRET:-}"
    [[ -n "${TAG:-}" ]] && echo "TAG=${TAG}"
  else
    echo "Конфиг не найден: $CONF"
  fi
  echo
}

изменить_tag() {
  load_conf
  [[ -f "$CONF" ]] || { echo "Сначала создайте прокси (пункт 1)." >&2; return 1; }
  read -r -p "Введите TAG (пусто чтобы очистить): " newtag
  save_conf "${PORT}" "${SECRET}" "$newtag"
  echo "TAG обновлён. Чтобы применить — перезапустите (пункт 3)."
}

пересоздать_секрет() {
  load_conf
  [[ -f "$CONF" ]] || { echo "Сначала создайте прокси (пункт 1)." >&2; return 1; }
  local newsecret; newsecret="$(rand_hex_16bytes)"
  save_conf "${PORT}" "$newsecret" "${TAG:-}"
  echo "Секрет обновлён. Чтобы применить — перезапустите (пункт 3)."
  показать_ссылку
}

изменить_порт() {
  load_conf
  [[ -f "$CONF" ]] || { echo "Сначала создайте прокси (пункт 1)." >&2; return 1; }
  local newport
  newport="$(choose_port)" || return 1
  [[ "$newport" == "back" ]] && return 0
  save_conf "$newport" "${SECRET}" "${TAG:-}"
  echo "Порт обновлён. Чтобы применить — перезапустите (пункт 3)."
}

перезапуск() {
  остановить_прокси || true
  запустить_прокси
}

удалить_всё() {
  ensure_docker
  docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1 || true
  rm -f "$CONF"
  echo "Удалено: контейнер и конфиг."
}

главное_меню() {
  require_root
  while true; do
    echo
    echo "=========== MTProto Proxy (менеджер) ==========="
    echo "1) Создать/Запустить MTProto Proxy"
    echo "2) Остановить"
    echo "3) Перезапустить"
    echo "4) Статус"
    echo "5) Показать ссылку для Telegram"
    echo "6) Изменить порт (80/443 запрещены)"
    echo "7) Пересоздать секрет"
    echo "8) Задать/очистить TAG"
    echo "9) Удалить всё (контейнер + конфиг)"
    echo "0) Выход"
    echo "================================================"
    read -r -p "Ваш выбор: " c

    case "$c" in
      1) запустить_прокси ;;
      2) остановить_прокси ;;
      3) перезапуск ;;
      4) статус ;;
      5) показать_ссылку ;;
      6) изменить_порт ;;
      7) пересоздать_секрет ;;
      8) изменить_tag ;;
      9) удалить_всё ;;
      0) exit 0 ;;
      *) echo "Неверный выбор." ;;
    esac
  done
}

главное_меню
